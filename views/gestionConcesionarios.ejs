<!DOCTYPE html>
<html lang="es-ES">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- mobile friendly -->
    <title>Gestión Concesionarios</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel = "stylesheet" href = "/css/stylesInicio.css">
</head>
<body>
    <header>
      <%- include('navbar') %>
    </header>

      <div class="container my-5">
        <h2 class="mb-4">Gestión de Concesionarios</h2>

        <div class="row mb-4 align-items-center">
          <!--Buscador y botón en la misma fila, alineados a la derecha -->
          <div class="col-md-8 offset-md-4">
            <div class="d-flex gap-3 justify-content-end">
              <!--Buscador -->
              <input type="text" 
                     id="buscador" 
                     class="form-control" 
                     placeholder="Buscar por nombre o ciudad..." 
                     style="max-width: 380px;">
              
              <!--Botón Nuevo concesionario -->
              <button type="button" 
                      class="btn btn-success" 
                      data-bs-toggle="modal" 
                      data-bs-target="#modalConcesionario">
                Nuevo concesionario
              </button>
            </div>
          </div>
        </div>
      <!--Tabla de los concesionarios-->
      <div class="table-responsive shadow-sm rounded-4 border">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th><th>Nombre</th><th>Ciudad</th><th>Dirección</th><th>Teléfono</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo">
            <% if(concesionarios.length > 0){ %>
              <% concesionarios.forEach((c) => { %>
                <tr>
                    <td><%= c.id_concesionario %></td>
                    <td><%= c.nombre %></td>
                    <td><%= c.ciudad %></td>
                    <td><%= c.direccion %></td>
                    <td><%= c.telefono_contacto %></td>
                    <td>
                       <!--Botón para editar concesionario con un modal-->
                       <button type="button" 
                       class="btn btn-sm btn-warning" 
                       data-bs-toggle="modal" 
                       data-bs-target="#modalEditarConcesionario"
                       data-id="<%= c.id_concesionario %>"
                       data-nombre="<%= c.nombre %>"
                       data-ciudad="<%= c.ciudad %>"
                       data-direccion="<%= c.direccion %>"
                       data-telefono="<%= c.telefono_contacto %>">
                   Editar
               </button>
                       <!--Botón para eliminar concesionario-->
                       <form action="/eliminar-concesionario/<%= c.id_concesionario %>" method="POST" class="d-inline">
                           <button type="submit" class="btn btn-sm btn-danger">Baja</button>
                       </form>
                    </td>
                </tr>
              <% }) %>
            <% } else { %>
                <tr>
                  <td colspan="7" class="text-center">No hay concesionarios.</td>
                </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <!--Modal nuevo concesionario--> 
      <div class="modal fade" id="modalConcesionario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form action="/crear-concesionario" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Datos del Concesionario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label>Nombre</label>
                  <input type="text" name="nombre" class="form-control" required>
                </div>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label>Ciudad</label>
                    <input type="text" name="ciudad" class="form-control" required>
                  </div>
                  <div class="col-6 mb-3">
                    <label>Dirección</label>
                    <input type="text" name="direccion" class="form-control" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label>Teléfono</label>
                  <input type="text" name="telefono_contacto" class="form-control" 
                  maxlength="9" 
                  pattern="[0-9]{9}"
                  oninput="this.value=this.value.replace(/[^0-9]/g,'')"
                  value="<%= typeof telefono !== 'undefined' ? telefono : '' %>"required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!--Modal editar concesionario-->
    <div class="modal fade" id="modalEditarConcesionario" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <form id="formEditar" method="POST"> 
                  <div class="modal-header">
                      <h5 class="modal-title">Editar Concesionario</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <!--Cuerpo del modal editar concesionario-->
                  <div class="modal-body">
                      <div class="row">
                          <div class="col-6 mb-3">
                              <label>Nombre</label>
                              <input type="text" name="nombre" id="edit_nombre" class="form-control" required>
                          </div>
                          <div class="col-6 mb-3">
                              <label>Ciudad</label>
                              <input type="text" name="ciudad" id="edit_ciudad" class="form-control" required>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-6 mb-3">
                              <label>Dirección</label>
                              <input type="text" name="dirección" id="edit_direccion" class="form-control" required>
                          </div>
                          <div class="col-6 mb-3">
                              <label>Teléfono</label>
                              <input type="number" name="telefono_contacto" id="edit_telefono_contacto" class="form-control" 
                              maxlength="9" 
                              pattern="[0-9]{9}"
                              oninput="this.value=this.value.replace(/[^0-9]/g,'')"
                              value="<%= typeof telefono !== 'undefined' ? telefono : '' %>"required>
                          </div>
                      </div>
                  </div>
                  <!--Footer del modal editar vehiculo-->
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                  </div>
              </form>
          </div>
      </div>
    </div>

      <footer>
        <!--Importamos el footer que tenemos creado-->
        <div id="footer-container"></div>
        <script>
          fetch('/footer.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('footer-container').innerHTML = html; 
            });
        </script>
      </footer> 

    <script>
      //actualización dinámica del buscador
      document.getElementById('buscador').addEventListener('keyup', function() {
          let valor = this.value.toLowerCase();
          let filas = document.querySelectorAll('#tablaCuerpo tr');
          filas.forEach(fila => {
              let texto = fila.textContent.toLowerCase();
              fila.style.display = texto.includes(valor) ? '' : 'none';
          });
      });
    </script>

    <!--Script para rellenar el modal de editar concesionario-->
    <script>
      const modalEditar = document.getElementById('modalEditarConcesionario');

      // Escuchamos el evento de Bootstrap que avisa cuando el modal se está abriendo
      modalEditar.addEventListener('show.bs.modal', function (event) {
          //Botón que ha activado el modal
          const boton = event.relatedTarget; 

          //Conseguimos los datos del vehiculo del boton
          const id = boton.getAttribute('data-id');
          const nombre = boton.getAttribute('data-nombre');
          const ciudad = boton.getAttribute('data-ciudad');
          const direccion = boton.getAttribute('data-direccion');
          const telefono = boton.getAttribute('data-telefono');

          //Rellenamos los inputs
          document.getElementById('edit_nombre').value = nombre;
          document.getElementById('edit_ciudad').value = ciudad;
          document.getElementById('edit_direccion').value = direccion;
          document.getElementById('edit_telefono_contacto').value = telefono;
          
          //actualizamos la acción del formulario para incluir el ID del concesionario
          const form = document.getElementById('formEditar');
          form.action = '/editar-concesionario/' + id; // Llamamos al post de verdad
      });
  </script>
</body>
</html>